name: Deploy to Azure

on:
  push:
    branches:
      - main
      - terraform-flask-deployment

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: container-app-deploy

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Azure CLI
      uses: azure/CLI@v1

    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Build and push Docker image
      run: |
        ACR_NAME=acaalbumsbtindol
        API_NAME=album-api
        az acr build --registry $ACR_NAME --image $API_NAME .

    - name: Create container app environment
      run: |
        az containerapp env create --name env-album-containerapps --resource-group album-containerapps --location canadacentral

    - name: Deploy image to container app
      run: |
        az containerapp create --name album-api --resource-group album-containerapps --environment env-album-containerapps --image "acaalbumsbtindol.azurecr.io/album-api" --target-port 8080 --ingress external --registry-server "acaalbumsbtindol.azurecr.io"
